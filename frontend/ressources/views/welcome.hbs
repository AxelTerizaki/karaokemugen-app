<!--Header start==================== -->
<div class="navbar-default navbar-fixed-top" id="navigation">
	<div class="container">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<nav class="collapse navbar-collapse" id="navbar">
			<ul class="nav navbar-nav navbar-right" id="top-nav">
				<li class="current hidden"><a href="#body">Home</a></li>
				<li><a href="#about" class="hidden">{{i18n "WLCM_ABOUTUS"}}</a></li>
				<li><a href="http://mugen.karaokes.moe/contact.html" target="_blank"><i
							class="glyphicon glyphicon-pencil"></i> {{i18n "WLCM_CONTACT"}}</a></li>
				<li><a href="http://mugen.karaokes.moe/" target="_blank"><i class="glyphicon glyphicon-link"></i>
						{{i18n "WLCM_SITE"}}</a></li>
				<li><a href="#" id="wlcm_login"><i class="glyphicon glyphicon-user"></i>
						<span>{{i18n "NOT_LOGGED"}}</span></a></li>
				<li id="wlcm_disconnect" style="display:none"><a href="#" title="{{i18n "LOGOUT"}}" class="logout"><i
							class="glyphicon glyphicon-log-out"></i> <span>{{i18n "LOGOUT"}}</span></a></li>
			</ul>
		</nav><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</div>

<section id="center-area">
	<div class="container">
		<div class="row">
			<div class="col-md-12 logoDiv">
				<h1 class="wow">
					<img class="logo-1" height="122" src="/ressources/img/Logo-final-fond-transparent.png" alt="LOGO">
				</h1>
			</div>
			<div class="col-md-12 text-center catchPhrase">
				{{{ catchphrases }}}
			</div>
			<div class="col-md-12 block wow menu zoomIn">

				<ul id="welcome_dashboard">
					<li class="manage">
						<div class="dash days_dash">
							<i class="digit glyphicon glyphicon-list normalText"></i>
							<i class="digit glyphicon glyphicon-hand-right tutorialText"></i>
							<div class="dash_title normalText">{{i18n "WLCM_KARAMANAGER"}}</div>
							<div class="dash_title tutorialText">{{i18n "WLCM_GETSTARTED"}}</div>
						</div>
					</li>
					<li>
						<div class="dash hours_dash">
							<i class="digit glyphicon glyphicon-cog"></i>
							<div class="dash_title">{{i18n "WLCM_ADMINISTRATION"}}</div>
						</div>
					</li>
					<li>
						<div class="dash seconds_dash">
							<i class="digit glyphicon glyphicon-user"></i>
							<div class="dash_title">{{i18n "WLCM_PUBLIC"}}</div>
						</div>
					</li>
					<li class="hidden">
						<div class="dash seconds_dash">
							<i class="digit glyphicon glyphicon-refresh"></i>
							<div class="dash_title">{{i18n "WLCM_UPDATE"}}</div>
						</div>
					</li>
					<li>
						<div class="dash minutes_dash">
							<i class="digit glyphicon glyphicon-question-sign"></i>
							<div class="dash_title">{{i18n "WLCM_HELP"}}</div>
						</div>
					</li>
				</ul>

			</div>
			<div class="col-md-12 wow block zoomIn perfectScrollbar">
				<ul class="news">

				</ul>

			</div>
		</div><!-- .row close -->
	</div><!-- .container close -->
</section><!-- header close -->

<div class="toastMessageContainer"></div>
<!-- Js -->
<script>

	var query = {{{ query }}};
	var scope = 'welcome';
	var appFirstRun = {{ appFirstRun }} == true;
	var webappMode = 2;
	welcomeScreen = true;
</script>
<script src="/ressources/vendors/js/jquery-3.2.1.min.js"></script>
<script src="/ressources/vendors/js/select2.min.js"></script>
<script src="/ressources/vendors/js/bootstrap.min.js"></script>
<script src="/ressources/vendors/js/i18n.js"></script>

<script src="/ressources/vendors/js/assignIE.js"></script>
<script src="/ressources/vendors/js/bootstrap-switch.min.js"></script>
<script src="/ressources/vendors/js/jquery-ui.min.js"></script>
<script src="/ressources/vendors/js/jquery.ui.touch-punch.min.js"></script>
<script src="/ressources/vendors/js/hammer.min.js"></script>
<script src="/ressources/vendors/js/hammer-time.min.js"></script>
<script src="/ressources/vendors/js/velocity.min.js"></script>
<script src="/ressources/vendors/js/perfect-scrollbar.jquery.min.js"></script>
<script src="/ressources/vendors/js/intro.js"></script>
<script src="/ressources/vendors/js/sprintf.min.js"></script>
<script src="/build/app.js"></script>
<script src="/ressources/js/karaokemugen.js"></script>
<script src="/ressources/js/admin.js"></script>
<script src="/ressources/js/tools.js"></script>
<script>
	$(function () {
		$.ajax({
			url: 'public/newsfeed',
			success: function (data) {
				var base = data[0];
				var appli = data[1];
				var mast = data[2];
				var news = [];
				if (base.body && appli.body) {
					base.body = JSON.parse(base.body);
					appli.body = JSON.parse(appli.body);
					news =
						[
							{
								html: base.body.feed.entry[0].content._text,
								date: base.body.feed.entry[0].updated._text,
								dateStr: new Date(base.body.feed.entry[0].updated._text).toLocaleDateString(),
								title: i18n.__("BASE_UPDATE") + ' : ' + base.body.feed.title._text + ' - ' + base.body.feed.entry[0].summary._text,
								link: base.body.feed.entry[0].link._attributes.href,
								type: 'base',
							},
							{
								html: appli.body.feed.entry[0].content._text,
								date: appli.body.feed.entry[0].updated._text,
								dateStr: new Date(appli.body.feed.entry[0].updated._text).toLocaleDateString(),
								title: i18n.__("APP_UPDATE") + ' : ' + appli.body.feed.entry[0].title._text + ' - ' + appli.body.feed.entry[0].summary._text,
								link: appli.body.feed.entry[0].link._attributes.href,
								type: 'app',
							},
						];
				}

				if (mast.body) {
					mast.body = JSON.parse(mast.body);
					for (var i = 0; i < 3; i++) {
						news.push({
							html: mast.body.rss.channel.item[i].description._text,
							date: mast.body.rss.channel.item[i].pubDate._text,
							dateStr: new Date(mast.body.rss.channel.item[i].pubDate._text).toLocaleDateString(),
							title: mast.body.rss.channel.item[i].title._text,
							link: mast.body.rss.channel.item[i].link._text,
							type: 'mast',
						});
					}
				}
				news.sort((a, b) => {
					var dateA = new Date(a.date);
					var dateB = new Date(b.date);
					return dateA < dateB ? 1 : dateA > dateB ? -1 : 0;
				});
				var $news = $('.news');
				news.forEach((e) => {
					$news.append('<li class="new" type="' + e.type + '">'
						+ '<p class="new-header"><b>' + e.title + '</b>'
						+ '<a href="' + e.link + '" target="_blank">' + e.dateStr + '</a></p>'
						+ '<p>' + e.html + '</p>'
						+ '</li>');
				});
				$('.new').each((k, e) => {
					if ($(e).prop('scrollHeight') > $(e).outerHeight()) {
						$(e).addClass('overflowed');
					}
				});
			}
		});
		$('.perfectScrollbar').perfectScrollbar();
	});

	if (window.location.search.indexOf('admpwd') > -1) {
		$('.manage').addClass('tutorial');
	}
	$('#admin').click(() => {
		window.open('/admin' + window.location.search, '_blank');
	});
	$('#wlcm_login').click(() => {
		if (!logInfos.username) {
			window.callLoginModal(scope);
		} else {
			window.callProfileModal(true);
		}
	});

	$('#welcome_dashboard').on('click', 'li', (e, k) => {
		var index = $(e.currentTarget).index();

		switch (index) {
			case 0: window.open('/admin' + window.location.search, '_blank');
				break;
			case 1: window.open('/system', '_blank');
				break;
			case 4: window.open('http://mugen.karaokes.moe/docs/', '_blank');
				break;
			case 2: window.open('/' + window.location.search, '_blank');
				break;
		}

	});

	$('.news').on('click', '.new', function (e) {
		var $target = $(e.target);
		if (!$target.is('a')) {
			var $this = $(this);
			$this.toggleClass('open');
		} else {
			// TODO make something more generic
			if ($target.attr('href').indexOf('/') === 0) {
				e.preventDefault();
				e.stopPropagation();
				window.open('https://lab.shelter.moe' + $target.attr('href'));
			}
		}
	});

</script>